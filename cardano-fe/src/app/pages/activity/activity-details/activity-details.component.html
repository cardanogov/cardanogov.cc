<div *ngIf="!isLoadingData">
  <!-- Details -->
  <div class="details-card">
    <!-- first row -->
    <!-- <div class="my-3">
			<div class="card p-3 shadow-sm">
				<h5 class="mb-2">{{ proposalDetails.title}}</h5>
				<div class="row text-muted small">
					<div class="col-md-4">
						<div><strong>Hash</strong></div>
						<div class="text-truncate"><span>{{ proposalDetails.hash }}</span> <nb-icon
								(click)="copyToClipboard(proposalDetails.hash)" icon="copy-outline"
								pack="eva"></nb-icon></div>
					</div>
					<div class="col-md-5">
						<div><strong>Action ID</strong></div>
						<div class="text-truncate"><span>{{ proposalDetails.proposalId }}</span> <nb-icon
								(click)="copyToClipboard(proposalDetails.proposalId)" icon="copy-outline"
								pack="eva"></nb-icon></div>
					</div>
					<div class="col-md-3">
						<div><strong>Status</strong></div>
						<div [ngClass]="{
							'text-danger': proposalDetails.status === 'Expired',
							'text-success': proposalDetails.status === 'Enacted',
							'text-primary': proposalDetails.status === 'Active'
						  }" class="fw-semibold">{{ proposalDetails.status }}</div>
					</div>
				</div>
			</div>
		</div> -->

    <!-- CARD SECTION -->
    <!-- <div class="card-section-container">
			<ng-container>
				<div class="stat-card">
					<div class="d-flex justify-content-between">
						<div class="d-flex flex-column">
							<p class="title">Timeline</p>
							<p class="value">{{ proposalDetails.timeLine }}</p>
						</div>
						<div class="icon-container">
							<nb-icon icon="clock-outline" pack="eva"></nb-icon>
						</div>
					</div>
				</div>

				<div class="stat-card">
					<div class="d-flex justify-content-between">
						<div class="d-flex flex-column">
							<p class="title">Governance Action Type</p>
							<p class="value">{{ proposalDetails.proposalType }}</p>
						</div>
						<div class="icon-container">
							<img src="assets/icons/document-icon.svg" alt="Icon">
						</div>
					</div>
				</div>

				<div class="stat-card">
					<div class="d-flex justify-content-between">
						<div class="d-flex flex-column">
							<p class="title">Total Voters {{totalVoterCount}}</p>
							<span class="value">
								<span class="vote-yes">Yes: {{totalVoter.cc.yes + totalVoter.spo.yes +
									totalVoter.drep.yes}} votes</span> |
								<span class="vote-no">No: {{totalVoter.cc.no + totalVoter.spo.no + totalVoter.drep.no}}
									votes</span> |
								<span class="vote-abstain">Abstain: {{totalVoter.cc.abstain + totalVoter.spo.abstain +
									totalVoter.drep.abstain}} votes</span>
							</span>
						</div>
						<div class="icon-container">
							<img src="assets/icons/live-icon.png" alt="Icon">
						</div>
					</div>
				</div>

				<div class="stat-card voting-card">
					<div class="title-container">
						<p class="title">Voting</p>
						<div class="icon-container">
							<img src="assets/icons/vote-icon.svg" alt="Icon">
						</div>
					</div>
					<button (click)="onVotingClick()" class="voting-button">Voting</button>
				</div>
			</ng-container>
		</div> -->

    <div class="spo-card">
      <div class="logo-container">
        <img
          [src]="proposalDetails.imageUrl || 'assets/icons/account-icon.svg'"
          alt="Pool Icon"
        />
      </div>
      <div class="card-content">
        <div class="header">
          <div class="title mb-2">Hash: {{ proposalDetails.title }}</div>
          <div class="address-container">
            <div class="address">
              {{ truncateMiddle(proposalDetails.hash || "") }}
            </div>
            <nb-icon
              icon="copy-outline"
              pack="eva"
              (click)="copyToClipboard(proposalDetails.hash || '')"
            ></nb-icon>
          </div>
          <div class="address-container">
            <div class="address">
              Action ID: {{ truncateMiddle(proposalDetails.proposalId || "") }}
            </div>
            <nb-icon
              icon="copy-outline"
              pack="eva"
              (click)="copyToClipboard(proposalDetails.proposalId || '')"
            ></nb-icon>
          </div>
        </div>
        <div class="stats">
          <div class="stat-item">
            <div class="icon-container">
              <img src="assets/icons/cc/group-icon.svg" alt="Members" />
            </div>
            <div class="value-container">
              <div class="value">{{ proposalDetails.proposalType }}</div>
              <div class="label">Governance Action Type</div>
            </div>
          </div>
          <div class="stat-item">
            <div class="icon-container">
              <img src="assets/icons/cc/vote-icon.svg" alt="Times voted" />
            </div>
            <div class="value-container">
              <div class="value">{{ totalVoterCount }}</div>
              <div class="label">Total Voters</div>
            </div>
          </div>
          <div class="stat-item">
            <div
              [class]="'icon-container ' + `${ proposalDetails.status?.toLowerCase()}`"
            >
              <img src="assets/icons/cc/arm-icon.svg" alt="Voting power" />
            </div>
            <div class="value-container">
              <div class="value">{{ proposalDetails.status }}</div>
              <div class="label">Status</div>
            </div>
          </div>
          <div class="stat-item">
            <div class="icon-container">
              <img src="assets/icons/cc/group-icon.svg" alt="Times voted" />
            </div>
            <div class="value-container">
              <div class="value">
                {{
                  proposalDetails.deposit
                    ? formatValue(proposalDetails.deposit) + " ADA"
                    : "N/A"
                }}
              </div>
              <div class="label">Deposit</div>
            </div>
          </div>
        </div>
        <div class="tenure">
          <div class="tenure-header">
            <div class="label">Timeline</div>
          </div>
          <div class="tenure-header">
            <div class="top-label">{{ proposalDetails.startTime }}</div>
            <div class="end-date">{{ proposalDetails.endTime }}</div>
          </div>
          <div class="progress-bar">
            <div
              class="progress"
              [ngStyle]="{
                width: timelineProgressPercentValue + '%',
                background: '#ffe600'
              }"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- third row -->
    <div class="mt-4 mb-5">
      <div class="grid-container">
        <!-- Cột 1: Action Constitutionality -->
        <div class="grid-item action-constitutionality">
          <nb-card class="table-card">
            <!-- header -->
            <nb-card-header class="table-card-header">
              <div class="header-container">
                <div
                  class="header-main d-flex justify-content-between align-items-center"
                >
                  <div class="d-flex align-items-center">
                    <img
                      src="assets/images/Logo - remove background-2.png"
                      alt="Cardano Logo"
                      class="logo"
                    />
                    <div class="d-flex flex-column">
                      <span class="title">Action Constitutionality</span>
                    </div>
                  </div>
                  <!-- {{proposalDetails.proposalType != 'NoConfidence' || proposalDetails.proposalType != 'NewCommittee' }} -->
                  <div class="d-flex align-items-center">
                    <span class="subtitle"
                      >Approval Threshold
                      {{
                        (proposalDetails.param_proposal || ""
                          | hasKey : "committee_max_term_length") ||
                        proposalDetails.proposalType == "InfoAction" ||
                          proposalDetails.proposalType == "NoConfidence" ||
                          proposalDetails.proposalType == "NewCommittee"
                          ? "--"
                          : "66,7%"
                      }}
                    </span>
                  </div>
                </div>
              </div>
            </nb-card-header>
            <!-- body -->
            <nb-card-body class="table-card-body">
              <div class="table-responsive">
                <table nbTable>
                  <thead>
                    <tr>
                      <th class="th-content">CC</th>
                      <th class="th-content">
                        <span
                          class="d-flex align-items-center justify-content-center"
                        >
                          Vote
                        </span>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of currentCommitteeData">
                      <td class="td-content d-flex align-items-center py-3">
                        <img
                          width="40px"
                          height="40px"
                          [src]="item.imageUrl"
                          class="mr-2"
                          alt="Logo"
                        />{{ item.key }}
                      </td>
                      <td>
                        <div
                          class="d-flex align-items-center justify-content-center"
                        >
                          <button class="vote-button" [ngClass]="item.color">
                            {{ item.vote }}
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Cột 2: Total Stake (DRep + SPO) -->
        <div class="grid-item total-stake">
          <nb-card class="threshold-card">
            <nb-card-header class="threshold-header">
              <div class="header-container">
                <div
                  class="header-main d-flex justify-content-between align-items-center"
                >
                  <div
                    class="d-flex align-items-center justify-content-between"
                  >
                    <img
                      src="assets/images/Logo - remove background-2.png"
                      alt="Cardano Logo"
                      class="logo"
                    />
                    <span class="title">DRep Total Stake</span>
                    <span class="value ml-2">{{ totalStakeNumbers }}B ₳</span>
                  </div>
                  <div>
                    <p class="approval-threshold mb-2">
                      Approval Threshold
                      <strong
                        >{{ drepApprovalThreshold
                        }}{{
                          drepApprovalThreshold === "--" ? "" : "%"
                        }}</strong
                      >
                    </p>
                  </div>
                </div>
              </div>
            </nb-card-header>
            <nb-card-body class="stake-body">
              <p
                *ngIf="
                  drepTotalStakeDetails.noPct === 0 &&
                  drepTotalStakeDetails.yesPct === 0
                "
              >
                Voting for Parameter change is not available to Dreps
              </p>
              <div
                *ngIf="
                  drepTotalStakeDetails.noPct != 0 &&
                  drepTotalStakeDetails.yesPct != 0
                "
                class="p-2"
                style="max-width: 500px"
              >
                <!-- Bar Section -->
                <div class="position-relative mb-3 mt-2" style="height: 25px">
                  <!-- Yes/No bar -->
                  <div
                    class="d-flex w-100 progress-bar-vote"
                    style="height: 100%; border-radius: 999px; overflow: hidden"
                  >
                    <div
                      class="bg-success text-white d-flex align-items-center justify-content-center"
                      [ngStyle]="{ width: drepTotalStakeDetails.yesPct + '%' }"
                    ></div>
                    <div
                      class="bg-danger text-white d-flex align-items-center justify-content-center"
                      [ngStyle]="{ width: drepTotalStakeDetails.noPct + '%' }"
                    ></div>
                    <div
                      class="bg-warning text-white d-flex align-items-center justify-content-center"
                      [ngStyle]="{ width: abstainPctDrep + '%' }"
                    ></div>
                  </div>
                  <!-- Purple vertical line -->
                  <div
                    class="position-absolute triangle-pointer"
                    *ngIf="drepApprovalThreshold !== '--'"
                    [ngStyle]="{
                      left: milestonePercent(drepApprovalThresholdPct, drepTotalStakeDetails.yesPct, drepTotalStakeDetails.noPct, abstainPctDrep) + '%',
                      top: '0',
                      bottom: '0',
                      width: '2px',
                      backgroundColor: '#2596be'
                    }"
                  ></div>

                  <!-- Bubble label -->
                  <div
                    class="position-absolute position-absolute-label"
                    *ngIf="drepApprovalThreshold !== '--'"
                    [ngStyle]="{
                      left: milestonePercent(drepApprovalThresholdPct, drepTotalStakeDetails.yesPct, drepTotalStakeDetails.noPct, abstainPctDrep) + '%',
                      top: '-30px',
                      transform: 'translateX(-50%)'
                    }"
                  >
                    <div
                      class="bubble-label px-2 py-1 text-white"
                      style="font-size: 0.75rem; background-color: #2596be"
                    >
                      ₳{{ drepApprovalThresholdVote }}B –
                      {{ drepApprovalThreshold }}%
                    </div>
                  </div>
                </div>

                <!-- Yes/No Stake Info -->
                <div class="d-flex justify-content-between mb-2">
                  <div class="text-success fw-semibold">
                    ₳ {{ drepTotalStakeDetails.yesVotes }}B –
                    {{ drepTotalStakeDetails.yesPct }}%
                  </div>
                  <div class="text-danger fw-semibold">
                    ₳ {{ drepTotalStakeDetails.noVotes }}B –
                    {{ drepTotalStakeDetails.noPct }}%
                  </div>
                </div>

                <!-- Metric Table -->
                <table class="table table-bordered text-center mb-0">
                  <thead>
                    <tr>
                      <th></th>
                      <th>
                        Yes
                        <span
                          style="
                            display: inline-block;
                            width: 12px;
                            height: 12px;
                            background-color: #198754;
                            border-radius: 2px;
                            margin-left: 4px;
                          "
                        ></span>
                      </th>
                      <th>
                        No
                        <span
                          style="
                            display: inline-block;
                            width: 12px;
                            height: 12px;
                            background-color: #dc3545;
                            border-radius: 2px;
                            margin-left: 4px;
                          "
                        ></span>
                      </th>
                      <th>No Confidence</th>
                      <th>Not Voted</th>
                      <th>
                        Abstain
                        <span
                          style="
                            display: inline-block;
                            width: 12px;
                            height: 12px;
                            background-color: #ffc107;
                            border-radius: 2px;
                            margin-left: 4px;
                          "
                        ></span>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="align-middle"><b>Power</b></td>
                      <td>{{ drepTotalStakeDetails.yesVotes.toFixed(2) }}B</td>
                      <td>{{ drepTotalStakeDetails.noVotes.toFixed(2) }}B</td>
                      <td>
                        {{ drepTotalStakeDetails.noConfidence.toFixed(2) }}B
                      </td>
                      <td>{{ drepStakeNotVote.toFixed(2) }}B</td>
                      <td>
                        {{
                          (
                            drepTotalStakeDetails.abstainAlways +
                            drepTotalStakeDetails.abstainActive
                          ).toFixed(2)
                        }}B
                      </td>
                    </tr>
                    <tr class="voter-row">
                      <td class="align-middle"><b>Vote</b></td>
                      <td>{{ totalVoter?.drep?.yes || 0 }}</td>
                      <td>{{ totalVoter?.drep?.no || 0 }}</td>
                      <td></td>
                      <td></td>
                      <td>{{ totalVoter?.drep?.abstain || 0 }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </nb-card-body>
          </nb-card>

          <nb-card class="threshold-card mt-4">
            <nb-card-header class="threshold-header">
              <div class="header-container">
                <div
                  class="header-main d-flex justify-content-between align-items-center"
                >
                  <div
                    class="d-flex align-items-center justify-content-between"
                  >
                    <img
                      src="assets/images/Logo - remove background-2.png"
                      alt="Cardano Logo"
                      class="logo"
                    />
                    <span class="title">SPO Total Stake</span>
                    <span class="value ml-2">{{ totalStake }}B ₳</span>
                  </div>
                  <div>
                    <p class="approval-threshold mb-2">
                      Approval Threshold
                      <strong
                        >{{ poolApprovalThreshold
                        }}{{
                          poolApprovalThreshold === "--" ? "" : "%"
                        }}</strong
                      >
                    </p>
                  </div>
                </div>
              </div>
            </nb-card-header>
            <nb-card-body class="stake-body">
              <p
                *ngIf="
                  spoTotalStakeDetails.noPct === 0 &&
                  spoTotalStakeDetails.yesPct === 0
                "
              >
                Voting for Parameter change is not available to SPOs
              </p>
              <div
                *ngIf="
                  spoTotalStakeDetails.noPct != 0 ||
                  spoTotalStakeDetails.yesPct != 0
                "
                class="p-2"
                style="max-width: 500px"
              >
                <!-- Bar Section -->
                <div class="position-relative mb-3 mt-2" style="height: 25px">
                  <!-- Yes/No bar -->
                  <div
                    class="d-flex w-100 progress-bar-vote"
                    style="height: 100%; border-radius: 999px; overflow: hidden"
                  >
                    <div
                      class="bg-success text-white d-flex align-items-center justify-content-center"
                      [ngStyle]="{ width: spoTotalStakeDetails.yesPct + '%' }"
                    ></div>
                    <div
                      class="bg-danger text-white d-flex align-items-center justify-content-center"
                      [ngStyle]="{ width: spoTotalStakeDetails.noPct + '%' }"
                    ></div>
                    <div
                      class="bg-warning text-white d-flex align-items-center justify-content-center"
                      [ngStyle]="{ width: abstainPctSpo + '%' }"
                    ></div>
                  </div>

                  <!-- Purple vertical line -->
                  <div
                    class="position-absolute triangle-pointer"
                    *ngIf="poolApprovalThreshold !== '--'"
                    [ngStyle]="{
                      left: milestonePercent(poolApprovalThresholdPct, spoTotalStakeDetails.yesPct, spoTotalStakeDetails.noPct, abstainPctSpo) + '%',
                      top: '0',
                      bottom: '0',
                      width: '2px',
                      backgroundColor: '#2596be'
                    }"
                  ></div>

                  <!-- Bubble label -->
                  <div
                    class="position-absolute position-absolute-label"
                    *ngIf="poolApprovalThreshold !== '--'"
                    [ngStyle]="{
                      left: milestonePercent(poolApprovalThresholdPct, spoTotalStakeDetails.yesPct, spoTotalStakeDetails.noPct, abstainPctSpo) + '%',
                      top: '-30px',
                      transform: 'translateX(-50%)'
                    }"
                  >
                    <div
                      class="bubble-label px-2 py-1 text-white"
                      style="font-size: 0.75rem; background-color: #2596be"
                    >
                      ₳{{ poolApprovalThresholdVote }}B –
                      {{ poolApprovalThreshold }}%
                    </div>
                  </div>
                </div>

                <!-- Yes/No Stake Info -->
                <div class="d-flex justify-content-between mb-2">
                  <div class="text-success fw-semibold">
                    ₳ {{ spoTotalStakeDetails.yesVotes }}B –
                    {{ spoTotalStakeDetails.yesPct }}%
                  </div>
                  <div class="text-danger fw-semibold">
                    ₳ {{ spoTotalStakeDetails.noVotes }}B –
                    {{ spoTotalStakeDetails.noPct }}%
                  </div>
                </div>

                <!-- Metric Table -->
                <table class="table table-bordered text-center mb-0">
                  <thead>
                    <tr>
                      <th></th>
                      <th>
                        Yes
                        <span
                          style="
                            display: inline-block;
                            width: 12px;
                            height: 12px;
                            background-color: #198754;
                            border-radius: 2px;
                            margin-left: 4px;
                          "
                        ></span>
                      </th>
                      <th>
                        No
                        <span
                          style="
                            display: inline-block;
                            width: 12px;
                            height: 12px;
                            background-color: #dc3545;
                            border-radius: 2px;
                            margin-left: 4px;
                          "
                        ></span>
                      </th>
                      <th>No Confidence</th>
                      <th>Not Voted</th>
                      <th>
                        Abstain
                        <span
                          style="
                            display: inline-block;
                            width: 12px;
                            height: 12px;
                            background-color: #ffc107;
                            border-radius: 2px;
                            margin-left: 4px;
                          "
                        ></span>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="align-middle"><b>Power</b></td>
                      <td>{{ spoTotalStakeDetails.yesVotes.toFixed(2) }}B</td>
                      <td>{{ spoTotalStakeDetails.noVotes.toFixed(2) }}B</td>
                      <td>
                        {{ spoTotalStakeDetails.noConfidence.toFixed(2) }}B
                      </td>
                      <td>{{ spoStakeNotVote.toFixed(2) }}B</td>
                      <td>
                        {{
                          (
                            spoTotalStakeDetails.abstainAlways +
                            spoTotalStakeDetails.abstainActive
                          ).toFixed(2)
                        }}B
                      </td>
                    </tr>
                    <tr class="voter-row">
                      <td class="align-middle"><b>Vote</b></td>
                      <td>{{ totalVoter?.spo?.yes || 0 }}</td>
                      <td>{{ totalVoter?.spo?.no || 0 }}</td>
                      <td></td>
                      <td></td>
                      <td>
                        {{
                          (totalVoter?.spo?.abstain || 0) +
                            (totalVoter?.spo?.abstainAlways || 0)
                        }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </nb-card-body>
          </nb-card>
        </div>
        <!-- Cột 3: Vote Analysis -->
        <div class="grid-item chart-container mt-4">
          <app-chart
            title="Vote Analysis"
            (expand)="openModal('voteAnalysisChart', 'Vote Analysis')"
          >
            <canvas #voteAnalysisChart></canvas>
          </app-chart>
        </div>
      </div>
      <div class="mt-5">
        <app-table
          [columns]="tableColumns"
          [data]="filteredData"
          [filters]="tableFilters"
          [currentPage]="currentPage"
          [itemsPerPage]="10"
          [totalItems]="totalItems"
          (pageChange)="onPageChange($event)"
          (filterChange)="onFilterChange($event)"
          (searchChange)="onSearchChange($event)"
          title="Voting Information"
          [loading]="isTableLoading"
        >
        </app-table>
      </div>
    </div>
  </div>

  <!-- Reasoning -->
  <nb-card class="threshold-card col-12 mt-4">
    <nb-card-header class="threshold-header">
      <div class="header-container">
        <div class="header-main">
          <div class="d-flex align-items-center">
            <img
              src="assets/images/Logo - remove background-2.png"
              alt="Cardano Logo"
              class="logo"
            />
            <span class="title">Reasoning</span>
          </div>
        </div>
      </div>
    </nb-card-header>
    <nb-card-body>
      <nb-accordion>
        <nb-accordion-item>
          <nb-accordion-item-header>Abstract</nb-accordion-item-header>
          <nb-accordion-item-body>
            <markdown [data]="abstract"></markdown>
          </nb-accordion-item-body>
        </nb-accordion-item>
        <nb-accordion-item>
          <nb-accordion-item-header>Motivation</nb-accordion-item-header>
          <nb-accordion-item-body>
            <markdown [data]="motivation"></markdown>
          </nb-accordion-item-body>
        </nb-accordion-item>
        <nb-accordion-item>
          <nb-accordion-item-header>Rationale</nb-accordion-item-header>
          <nb-accordion-item-body>
            <markdown [data]="rationale"></markdown>
          </nb-accordion-item-body>
        </nb-accordion-item>
        <nb-accordion-item>
          <nb-accordion-item-header
            >Metadata anchor link</nb-accordion-item-header
          >
          <nb-accordion-item-body>
            {{ anchorLink }}
          </nb-accordion-item-body>
        </nb-accordion-item>
        <nb-accordion-item>
          <nb-accordion-item-header>Supporting links</nb-accordion-item-header>
          <nb-accordion-item-body>
            <div *ngFor="let item of supportLink; let i = index">
              <p><b>Label:</b> {{ item.label }}</p>
              <p><b>Uri:</b> {{ item.uri }}</p>
            </div>
          </nb-accordion-item-body>
        </nb-accordion-item>
      </nb-accordion>
    </nb-card-body>
  </nb-card>
</div>

<!-- Loading State -->
<div *ngIf="isLoadingData" class="loading-container">
  <div class="details-card">
    <!-- Loading skeleton for first row -->
    <div class="my-3 mt-4">
      <div class="card p-3 shadow-sm">
        <app-skeleton height="24px" width="60%" class="mb-2"></app-skeleton>
      </div>
    </div>

    <!-- Loading skeleton for cards section -->
    <div class="card-section-container mt-4">
      <app-skeleton
        height="125px"
        *ngFor="let i of [1, 2, 3, 4]"
      ></app-skeleton>
    </div>

    <!-- Loading skeleton for third row -->
    <div class="mt-4 mb-5">
      <div class="grid-container">
        <div class="grid-item">
          <app-skeleton height="400px"></app-skeleton>
        </div>
        <div class="grid-item">
          <app-skeleton height="400px"></app-skeleton>
        </div>
        <div class="grid-item">
          <app-skeleton height="400px"></app-skeleton>
        </div>
      </div>
    </div>

    <!-- Loading skeleton for table -->
    <div class="mt-5">
      <app-skeleton height="400px"></app-skeleton>
    </div>
  </div>
</div>
